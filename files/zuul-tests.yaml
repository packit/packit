---
- name: This is a recipe for how to run packit tests
  hosts: all
  vars:
    project_dir: /src
    with_testing: false
  tasks:
  - set_fact:
      project_dir: "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}"
    when: zuul is defined
  - name: stat {{ project_dir }}
    stat:
      path: '{{ project_dir }}'
    tags:
    - no-cache
    register: src_path
  - name: Let's make sure {{ project_dir }} is present
    assert:
      that:
      - 'src_path.stat.isdir'

  - name: Install test rpm dependencies
    dnf:
      name:
      - python3-flexmock
      - python3-pytest
      - python3-pytest-cov
      state: present
    become: true

  - name: Pip install sandcastle, our sandboxing tech (needed when running as a service)
    pip:
      name: git+https://github.com/packit-service/sandcastle
    become: true

  - name: Install packit from {{ project_dir }}
    pip:
      name: '{{ project_dir }}'
    become: true

  - name: Run tests
    command: make check
    args:
      chdir: '{{ project_dir }}'
    when: with_testing
